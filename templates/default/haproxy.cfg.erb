# This file is maintained by chef

global
  log <%= node['haproxy']['syslog']['dest'] %> <%= node['haproxy']['syslog']['facility'] %>
  maxconn <%= node['haproxy']['global']['maxconn'] %>
  #debug
  #quiet
  user haproxy
  group haproxy

defaults
  log     global
  mode    http
  option  httplog
  option httpclose
  option  dontlognull
  option  redispatch
  retries 3
  timeout connect <%= node['haproxy']['defaults']['timeout']['connect'] %>
  timeout client <%= node['haproxy']['defaults']['timeout']['client'] %>
  timeout server <%= node['haproxy']['defaults']['timeout']['server'] %>
  maxconn <%= node['haproxy']['defaults']['maxconn'] %>
  <% if node["haproxy"]["x_forwarded_for"] -%>
  option httpclose
  option forwardfor
  <% end -%>


listen stats :<%= node['haproxy']['stats']['port'] %>
  stats enable
  stats uri <%= node['haproxy']['stats']['uri'] %>
  stats auth <%= node['haproxy']['stats']['admin_user'] %>:<%= node['haproxy']['stats']['admin_password'] %>
  monitor-uri <%= node['haproxy']['monitor_uri'] %>

<%
  node['haproxy']['frontends'].each do |fe_name,fe_conf|
-%>

frontend <%= fe_name %> :<%= fe_conf['port'] %>
  <%
    unless fe_conf["disable_x_forwarded_for"]
  -%>
  option forwardfor if-none
  capture request header X-Forwarded-For len 51
  <%
    end # unless fe_conf["disable_x_forwarded_for"]
  -%>

  #
  # Endpoint acl definitions
  #

  <%
      if node['haproxy']["acls"]
        node['haproxy']["acls"].each do |acl_name,acl_conf|
  -%>
  acl <%= acl_name %> <%= acl_conf['type'] %><% unless acl_conf['case_sensitive'] %> -i<% end %> <%= acl_conf['match'] %>
  <%
        end # node['haproxy']["acls"].each
      end # if node['haproxy']["acls"]
  -%>

  # Old "host-only" endpoint acl definitions
  <%
      node["haproxy"]["applications"].select {|app,app_conf|
        app_conf["endpoint"]
      }.each do |app,app_conf|
  -%>
  acl host_endpoint_<%= app %> hdr_beg(host) -i <%= app_conf["endpoint"] %>
  <%
      end
  -%>

  <%
      unless fe_conf['ssl']
  -%>
  #
  # Forced SSL redirects (if any)
  #
  <%
        node['haproxy']['applications'].each do |app,app_conf|
          if app_conf['ssl_required']

            # Janky method of finding the actual hostname/fqdn of the request
            # and using it in the redirect.  Note that it doesn't handle
            # the eventuality of regex-based ACLs very well at all.

            app_endpoint_host_acl = app_conf["acls"].select {|a|
              node["haproxy"]["acls"][a.sub(/^!/,'')]["type"] == "hdr_beg(host)"
            }.first

            app_endpoint_host = node["haproxy"]["acls"][app_endpoint_host_acl]["match"]
  -%>
  redirect prefix https://<%= app_endpoint_host %> if <%= app_conf["acls"].join(' ') %><% if app_conf["endpoint"] %> or host_endpoint_<%= app %><% end %>
  <%
          end # if ssl_required
        end # node['haproxy']['applications'].each
      else # unless fe_conf['ssl']
  -%>
  # This makes sure everything passed through this frontend leaves
  # with exactly one X-Forwarded-Proto header indicating, in this
  # case, "https".
  reqidel ^X-Forwarded-Proto:.*
  reqadd   X-Forwarded-Proto:\ https

  <%
      end # fe_conf["ssl"]
  -%>

  #
  # use_backend rules (if any)
  #
  <%
      node['haproxy']['applications'].each do |app,app_conf|
        if ( fe_conf['ssl'] && app_conf['ssl_enabled'] ) ||
          ( ! fe_conf['ssl'] && ! app_conf['ssl_required'] )
  -%>
  use_backend <%= app_conf['backend'] %> if <%= app_conf["acls"].join(' ') %><% if app_conf["endpoint"] %> or host_endpoint_<%= app %><% end %>
  <%
        end # ( fe_conf['ssl'] && app_conf['ssl_enabled'] ) ||
       # ( ! fe_conf['ssl'] && ! app_conf['ssl_required'] )

      end # node['haproxy']['applications'].each

    end # node['haproxy']['frontends'].each
  -%>

<%
  node['haproxy']['backends'].each do |be_name,be_conf|
-%>

backend <%= be_name %>
  <%
    unless be_conf['mode'] && be_conf['mode'] == "tcp"
      if be_conf["cookie_prefix"]
  -%>
  cookie <%= be_conf["cookie_prefix"] %> prefix
  <%
      end # if be_conf["cookie_prefix"]
      if be_conf["cookie_insert"]
  -%>
  cookie <%= be_conf["cookie_insert"] %> insert indirect
  <%
      end # if be_conf["cookie_insert"]
      if be_conf['check_req'] &&
        be_conf['check_req']['method']
  -%>
  option httpchk <%= be_conf['check_req']['method'] %><% if be_conf['check_req']['url'] %> <%= be_conf['check_req']['url'] %><% end %>
  <%
      end # if be_conf['check_req']
    end # unless be_conf['mode'] && be_conf['mode'] == "tcp"
  -%>
  <%
    be_conf['servers'].each do |server|
  -%>
  server <%= server['name'] %> <%= server['fqdn'] %>:<%= server['port'] %><% if be_conf['check_req'] && be_conf['check_req']['always'] || be_conf['servers'].count > 1 %> check<% end %><% if server["options"] %> <%= server['options'].join(' ') %><% end %>
  <%
    end # be_conf['servers'].each
  -%>
<%
  end # node['haproxy']['backends'].each
-%>
